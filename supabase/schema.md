-- WARNING: This schema is for context only and is not meant to be run.
-- Table order and constraints may not be valid for execution.

CREATE TABLE public.companies (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  company_name character varying NOT NULL,
  contact_first_name character varying NOT NULL,
  contact_last_name character varying NOT NULL,
  contact_email character varying NOT NULL UNIQUE CHECK (contact_email::text ~* '^[A-Za-z0-9._%+-]+@[A-Za-z0-9.-]+\.[A-Za-z]{2,}$'::text),
  contact_phone character varying NOT NULL CHECK (char_length(contact_phone::text) >= 10),
  vat_number character varying,
  kvk_number character varying,
  website character varying,
  phone_verified boolean DEFAULT false,
  phone_verified_at timestamp with time zone,
  password_hash character varying,
  is_active boolean DEFAULT true,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  CONSTRAINT companies_pkey PRIMARY KEY (id)
);
CREATE TABLE public.personal_users (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  first_name character varying NOT NULL,
  last_name character varying NOT NULL,
  email character varying NOT NULL UNIQUE CHECK (email::text ~* '^[A-Za-z0-9._%+-]+@[A-Za-z0-9.-]+\.[A-Za-z]{2,}$'::text),
  phone character varying NOT NULL CHECK (char_length(phone::text) >= 10),
  phone_verified boolean DEFAULT false,
  phone_verified_at timestamp with time zone,
  password_hash character varying,
  is_active boolean DEFAULT true,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  CONSTRAINT personal_users_pkey PRIMARY KEY (id)
);
CREATE TABLE public.professional_certificates (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  professional_profile_id uuid NOT NULL,
  title character varying NOT NULL,
  issuing_organization character varying NOT NULL,
  issue_date date NOT NULL,
  expiry_date date NOT NULL,
  file_url text NOT NULL,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  CONSTRAINT professional_certificates_pkey PRIMARY KEY (id),
  CONSTRAINT professional_certificates_professional_profile_id_fkey FOREIGN KEY (professional_profile_id) REFERENCES public.professional_profiles(id)
);
CREATE TABLE public.professional_companies (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  company_name character varying NOT NULL,
  business_id character varying UNIQUE,
  postal_code character varying,
  house_number character varying,
  street_name character varying,
  city character varying,
  full_address text,
  business_email character varying,
  business_phone character varying,
  website character varying,
  vat_number character varying,
  is_verified boolean DEFAULT false,
  verification_status character varying DEFAULT 'pending'::character varying CHECK (verification_status::text = ANY (ARRAY['pending'::character varying, 'in_review'::character varying, 'verified'::character varying, 'rejected'::character varying, 'suspended'::character varying]::text[])),
  verification_documents jsonb,
  verified_at timestamp with time zone,
  verified_by uuid,
  business_description text,
  year_established integer,
  employee_count character varying,
  service_categories ARRAY,
  service_areas ARRAY,
  created_by uuid,
  is_active boolean DEFAULT true,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  business_id_type character varying,
  business_id_formatted character varying,
  country character varying,
  logo_url text,
  aggregate_rating numeric DEFAULT 0.00,
  total_ratings integer DEFAULT 0,
  CONSTRAINT professional_companies_pkey PRIMARY KEY (id),
  CONSTRAINT professional_companies_created_by_fkey FOREIGN KEY (created_by) REFERENCES auth.users(id)
);
CREATE TABLE public.professional_company_ratings (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  company_id uuid,
  rated_by_profile_id uuid,
  rating integer CHECK (rating >= 1 AND rating <= 5),
  review_text text,
  created_at timestamp without time zone,
  updated_at timestamp without time zone,
  CONSTRAINT professional_company_ratings_pkey PRIMARY KEY (id),
  CONSTRAINT professional_company_ratings_company_id_fkey FOREIGN KEY (company_id) REFERENCES public.professional_companies(id),
  CONSTRAINT professional_company_ratings_rated_by_profile_id_fkey FOREIGN KEY (rated_by_profile_id) REFERENCES public.professional_profiles(id)
);
CREATE TABLE public.professional_profiles (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  user_id uuid NOT NULL UNIQUE,
  first_name character varying NOT NULL,
  last_name character varying NOT NULL,
  email character varying NOT NULL UNIQUE,
  phone character varying,
  phone_verified boolean DEFAULT false,
  phone_verified_at timestamp with time zone,
  company_id uuid,
  role_in_company character varying,
  joined_company_at timestamp with time zone,
  is_active boolean DEFAULT true,
  is_verified character varying DEFAULT 'unverified'::character varying CHECK (is_verified::text = ANY (ARRAY['unverified'::character varying, 'pending'::character varying, 'in_review'::character varying, 'verified'::character varying, 'rejected'::character varying, 'suspended'::character varying]::text[])),
  profile_completed boolean DEFAULT false,
  bio text,
  years_of_experience integer,
  specializations ARRAY,
  certifications jsonb,
  notification_preferences jsonb DEFAULT '{"sms": false, "email": true}'::jsonb,
  availability_status character varying DEFAULT 'available'::character varying,
  auth_provider character varying,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  last_login_at timestamp with time zone,
  work_address text,
  work_postal_code character varying,
  work_city character varying,
  work_latitude numeric,
  work_longitude numeric,
  service_radius_km integer DEFAULT 10,
  quotes_email character varying,
  invoices_email character varying,
  gender character varying CHECK (gender::text = ANY (ARRAY['male'::character varying, 'female'::character varying, 'other'::character varying, 'prefer_not_to_say'::character varying]::text[])),
  current_step integer DEFAULT 1 CHECK (current_step >= 1 AND current_step <= 6),
  work_country character varying DEFAULT 'NL'::character varying,
  portfolio_photos ARRAY DEFAULT ARRAY[]::text[],
  profile_picture_url text,
  profile_answers jsonb DEFAULT '{}'::jsonb,
  CONSTRAINT professional_profiles_pkey PRIMARY KEY (id),
  CONSTRAINT professional_profiles_user_id_fkey FOREIGN KEY (user_id) REFERENCES auth.users(id),
  CONSTRAINT professional_profiles_company_id_fkey FOREIGN KEY (company_id) REFERENCES public.professional_companies(id)
);
CREATE TABLE public.professional_specializations (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  professional_id uuid NOT NULL,
  service_category_id bigint NOT NULL,
  priority integer NOT NULL DEFAULT 1,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  CONSTRAINT professional_specializations_pkey PRIMARY KEY (id),
  CONSTRAINT professional_specializations_professional_id_fkey FOREIGN KEY (professional_id) REFERENCES public.professional_profiles(id),
  CONSTRAINT professional_specializations_service_category_id_fkey FOREIGN KEY (service_category_id) REFERENCES public.service_categories(id)
);
CREATE TABLE public.professional_subcategories (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  professional_id uuid NOT NULL,
  subcategory_id bigint NOT NULL,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  CONSTRAINT professional_subcategories_pkey PRIMARY KEY (id),
  CONSTRAINT professional_subcategories_professional_id_fkey FOREIGN KEY (professional_id) REFERENCES auth.users(id),
  CONSTRAINT professional_subcategories_subcategory_id_fkey FOREIGN KEY (subcategory_id) REFERENCES public.service_subcategories(id)
);
CREATE TABLE public.project_drafts (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  service_category_id bigint,
  session_token character varying NOT NULL UNIQUE CHECK (char_length(session_token::text) >= 32),
  ip_address character varying,
  user_agent text,
  postcode character varying,
  execution_timing character varying,
  current_step integer DEFAULT 1,
  last_question_id character varying,
  is_completed boolean DEFAULT false,
  is_converted_to_project boolean DEFAULT false,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  expires_at timestamp with time zone DEFAULT (now() + '7 days'::interval),
  personal_user_id uuid,
  company_id uuid,
  request_type character varying CHECK (request_type::text = ANY (ARRAY['private'::character varying, 'business'::character varying]::text[])),
  city character varying,
  street_name character varying,
  street_number character varying,
  description text,
  has_photos boolean DEFAULT false,
  first_name character varying,
  last_name character varying,
  email character varying,
  phone character varying,
  company_name character varying,
  verification_code character varying,
  verification_expires_at timestamp with time zone,
  phone_verified boolean DEFAULT false,
  phone_verified_at timestamp with time zone,
  CONSTRAINT project_drafts_pkey PRIMARY KEY (id),
  CONSTRAINT project_drafts_service_category_id_fkey FOREIGN KEY (service_category_id) REFERENCES public.service_categories(id),
  CONSTRAINT project_drafts_personal_user_id_fkey FOREIGN KEY (personal_user_id) REFERENCES public.personal_users(id),
  CONSTRAINT project_drafts_company_id_fkey FOREIGN KEY (company_id) REFERENCES public.companies(id)
);
CREATE TABLE public.project_form_answers (
  id character varying NOT NULL,
  project_id uuid,
  question_id character varying,
  selected_option_id character varying,
  answer_text text,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  project_draft_id uuid,
  CONSTRAINT project_form_answers_pkey PRIMARY KEY (id),
  CONSTRAINT project_form_answers_project_id_fkey FOREIGN KEY (project_id) REFERENCES public.projects(id),
  CONSTRAINT project_form_answers_question_id_fkey FOREIGN KEY (question_id) REFERENCES public.project_form_questions(id),
  CONSTRAINT project_form_answers_selected_option_id_fkey FOREIGN KEY (selected_option_id) REFERENCES public.project_form_question_options(id),
  CONSTRAINT project_form_answers_project_draft_id_fkey FOREIGN KEY (project_draft_id) REFERENCES public.project_drafts(id)
);
CREATE TABLE public.project_form_question_options (
  id character varying NOT NULL,
  question_id character varying,
  option_value character varying NOT NULL,
  option_label_nl character varying NOT NULL,
  option_label_en character varying NOT NULL,
  has_follow_up boolean DEFAULT false,
  order_index integer NOT NULL DEFAULT 1,
  is_active boolean DEFAULT true,
  created_at timestamp with time zone DEFAULT now(),
  CONSTRAINT project_form_question_options_pkey PRIMARY KEY (id),
  CONSTRAINT project_form_question_options_question_id_fkey FOREIGN KEY (question_id) REFERENCES public.project_form_questions(id)
);
CREATE TABLE public.project_form_questions (
  id character varying NOT NULL,
  service_category_id bigint,
  question_text_nl text NOT NULL,
  question_text_en text NOT NULL,
  question_type character varying NOT NULL CHECK (question_type::text = ANY (ARRAY['radio'::character varying, 'checkbox'::character varying, 'text'::character varying, 'textarea'::character varying, 'select'::character varying, 'date'::character varying]::text[])),
  is_root_question boolean DEFAULT false,
  parent_question_id character varying,
  parent_option_id character varying,
  order_index integer NOT NULL DEFAULT 1,
  is_required boolean DEFAULT true,
  placeholder_nl character varying,
  placeholder_en character varying,
  help_text_nl text,
  help_text_en text,
  is_active boolean DEFAULT true,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  step_number integer DEFAULT 1,
  CONSTRAINT project_form_questions_pkey PRIMARY KEY (id),
  CONSTRAINT project_form_questions_service_category_id_fkey FOREIGN KEY (service_category_id) REFERENCES public.service_categories(id),
  CONSTRAINT project_form_questions_parent_question_id_fkey FOREIGN KEY (parent_question_id) REFERENCES public.project_form_questions(id),
  CONSTRAINT fk_parent_option FOREIGN KEY (parent_option_id) REFERENCES public.project_form_question_options(id)
);
CREATE TABLE public.project_form_steps (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  step_order integer NOT NULL UNIQUE CHECK (step_order >= 1),
  step_key character varying NOT NULL UNIQUE,
  is_category_specific boolean DEFAULT false,
  step_type character varying NOT NULL,
  is_required boolean DEFAULT true,
  is_active boolean DEFAULT true,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  CONSTRAINT project_form_steps_pkey PRIMARY KEY (id)
);
CREATE TABLE public.project_photos (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  project_id uuid,
  file_name character varying,
  file_size integer CHECK (file_size > 0 AND file_size <= 5242880),
  mime_type character varying,
  uploaded_at timestamp with time zone DEFAULT now(),
  project_draft_id uuid,
  storage_path text NOT NULL,
  display_order integer DEFAULT 1,
  is_primary boolean DEFAULT false,
  upload_status character varying DEFAULT 'completed'::character varying CHECK (upload_status::text = ANY (ARRAY['uploading'::character varying, 'completed'::character varying, 'failed'::character varying]::text[])),
  width integer,
  height integer,
  updated_at timestamp with time zone DEFAULT now(),
  CONSTRAINT project_photos_pkey PRIMARY KEY (id),
  CONSTRAINT project_photos_project_id_fkey FOREIGN KEY (project_id) REFERENCES public.projects(id),
  CONSTRAINT project_photos_project_draft_id_fkey FOREIGN KEY (project_draft_id) REFERENCES public.project_drafts(id)
);
CREATE TABLE public.project_progress (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  project_id uuid,
  step_number integer NOT NULL,
  is_completed boolean DEFAULT false,
  completed_at timestamp with time zone,
  created_at timestamp with time zone DEFAULT now(),
  CONSTRAINT project_progress_pkey PRIMARY KEY (id),
  CONSTRAINT project_progress_project_id_fkey FOREIGN KEY (project_id) REFERENCES public.projects(id)
);
CREATE TABLE public.projects (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  service_category_id bigint,
  request_type character varying,
  has_photos boolean DEFAULT false,
  description text,
  postcode character varying,
  street_number character varying,
  street_name character varying,
  city character varying,
  first_name character varying,
  last_name character varying,
  company_name character varying,
  email character varying,
  phone character varying,
  phone_verified boolean DEFAULT false,
  verification_code character varying,
  verification_expires_at timestamp with time zone,
  status character varying DEFAULT 'draft'::character varying,
  current_step integer DEFAULT 1,
  completed_at timestamp with time zone,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  personal_user_id uuid,
  company_id uuid,
  source_draft_id uuid,
  execution_timing character varying,
  phone_verified_at timestamp with time zone,
  access_token character varying UNIQUE,
  access_token_expires_at timestamp with time zone,
  CONSTRAINT projects_pkey PRIMARY KEY (id),
  CONSTRAINT projects_service_category_id_fkey FOREIGN KEY (service_category_id) REFERENCES public.service_categories(id),
  CONSTRAINT projects_personal_user_id_fkey FOREIGN KEY (personal_user_id) REFERENCES public.personal_users(id),
  CONSTRAINT projects_company_id_fkey FOREIGN KEY (company_id) REFERENCES public.companies(id),
  CONSTRAINT projects_source_draft_id_fkey FOREIGN KEY (source_draft_id) REFERENCES public.project_drafts(id)
);
CREATE TABLE public.service_categories (
  id bigint NOT NULL DEFAULT nextval('service_categories_id_seq'::regclass),
  slug character varying NOT NULL UNIQUE,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  updated_at timestamp with time zone NOT NULL DEFAULT now(),
  name_nl character varying,
  name_en character varying,
  icon_url text,
  CONSTRAINT service_categories_pkey PRIMARY KEY (id)
);
CREATE TABLE public.service_subcategories (
  id bigint NOT NULL DEFAULT nextval('service_subcategories_id_seq'::regclass),
  service_category_name character varying,
  slug character varying NOT NULL UNIQUE,
  name_nl character varying NOT NULL,
  name_en character varying,
  description_nl text,
  description_en text,
  price_particulier numeric,
  price_zakelijk numeric,
  icon_url text,
  sort_order integer DEFAULT 0,
  is_active boolean DEFAULT true,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  service_category_id bigint,
  CONSTRAINT service_subcategories_pkey PRIMARY KEY (id),
  CONSTRAINT fk_service_category FOREIGN KEY (service_category_id) REFERENCES public.service_categories(id)
);